<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualizing surface displacements from BUnwarpJ â€¢ map.displ.r</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Visualizing surface displacements from BUnwarpJ">
<meta property="og:description" content="map.displ.r">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">map.displ.r</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/1_BUnwarpJ_image_registration.html">BUnwarpJ image registration with DEMs</a>
    </li>
    <li>
      <a href="../articles/2_Visualizing_surface_displacements.html">Visualizing surface displacements from BUnwarpJ</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Visualizing surface displacements from BUnwarpJ</h1>
                        <h4 class="author">Jason Goetz</h4>
            
            <h4 class="date">2020-10-23</h4>
      
      
      <div class="hidden name"><code>2_Visualizing_surface_displacements.Rmd</code></div>

    </div>

    
    
<p>The <a href="https://imagej.net/BUnwarpJ">BUnwarpJ plugin</a> in the open-source image processing software <a href="https://imagej.net/Fiji">ImageJ/Fiji</a> can be a very useful tool for high-resolution surface deformation modelling from digital elevation models (DEMs). The <code>map.disp.r</code> package was built for importing bUnwarpJ image registration based on DEMs and computing displacements in the x,y and z directions.</p>
<p>This vignette</p>
<ul>
<li>Describes and illustrates how to import raw transformation files exported from BUnwarpJ</li>
<li>Shows how to create a raster of the displacements</li>
<li>Shows how to visualize displacements directions and magnitudes</li>
</ul>
<p>As a case study, we will map the deformation patterns of a rock glacier using DEMs that were derived from lidar and structure-from-motion topographic surveying <a href="https://www.sciencedirect.com/science/article/pii/S0034425719302949">(Goetz et al 2019)</a>.</p>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h3>
<p>To start, we will load our DEMs for the years 2012 and 2017 that were used for performing <a href="https://jngtz.github.io/map.displ.r/articles/1_BUnwarpJ_image_registration.html">image registration in BUnwarpJ</a> for displcament mapping.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://CRAN.R-project.org/package=raster">raster</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/edzer/sp">sp</a></span>)

<span class="kw">dem2012</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span>(<span class="st">"rock_glacier_dem_2012_50cm.tif"</span>)
<span class="kw">dem2017</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span>(<span class="st">"rock_glacier_dem_2017_50cm.tif"</span>)
</pre></div>
</div>
<div id="importing-bunwarpj-transformation-file" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-bunwarpj-transformation-file" class="anchor"></a>Importing BUnwarpJ transformation file</h3>
<p>The raw transformation file from BUnwarpJ describes the registration by providing the coordinates for each pixel of the source image and the corresponding row and column position of the target image. To apply this transformation to georeferenced images, we need to convert these positions to a local CRS. The <code><a href="../reference/dem.displacement.mapping.html">dem.displacement.mapping()</a></code> function does this for us by using the source and target DEMs used for performing image registration. Additionally, it computes the vertical displacement (in the z direction), as well as the direction (aspect) of the 2D (xy) displacements and the slope of the z displacement.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">map.displ.r</span>)
<span class="kw">f_tx</span> <span class="op">&lt;-</span> <span class="st">"RAW_rock_glacier_hillshade_2012_50cm_direct_transf.txt"</span>
<span class="kw">d_tx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dem.displacement.mapping.html">dem.displacement.mapping</a></span>(tx_file = <span class="kw">f_tx</span>, r_source = <span class="kw">dem2012</span>, r_target = <span class="kw">dem2017</span>)
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span>(<span class="kw">d_tx</span>)
</pre></div>
<pre><code>#&gt;   x_source y_source z_source x_target y_target z_target    x_disp     y_disp
#&gt; 1 967615.2  6441325 2452.823 967615.7  6441325 2452.533 0.5000486 -0.4277765
#&gt; 2 967615.7  6441325 2452.686 967616.2  6441325 2452.594 0.4972561 -0.4356877
#&gt; 3 967616.2  6441325 2452.659 967616.7  6441325 2452.632 0.4944839 -0.4430315
#&gt; 4 967616.7  6441325 2452.713 967617.2  6441325 2452.732 0.4917353 -0.4498284
#&gt; 5 967617.2  6441325 2452.777 967617.7  6441325 2452.789 0.4890138 -0.4560988
#&gt; 6 967617.7  6441325 2452.854 967618.2  6441325 2452.864 0.4863229 -0.4618633
#&gt;         z_disp   xy_disp  xyz_disp   aspect       slope
#&gt; 1 -0.290527344 0.6580588 0.7193382 130.5460 -23.8210508
#&gt; 2 -0.091552734 0.6611259 0.6674349 131.2243  -7.8841792
#&gt; 3 -0.026855469 0.6639211 0.6644641 131.8587  -2.3163393
#&gt; 4  0.019042969 0.6664452 0.6667172 132.4516   1.6367211
#&gt; 5  0.011962891 0.6687007 0.6688077 133.0054   1.0248980
#&gt; 6  0.009521484 0.6706919 0.6707595 133.5223   0.8133454</code></pre>
<p>Using <code>raster</code> we can assign the values of the displacement mapping to a grid. This is useful for exporting.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># Assign displacement values to an emptry raster to export</span>
<span class="kw">r_na</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/setValues.html">setValues</a></span>(<span class="kw">dem2012</span>, <span class="fl">NA</span>)
<span class="kw">disp_3d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/setValues.html">setValues</a></span>(<span class="kw">r_na</span>, <span class="kw">d_tx</span><span class="op">$</span><span class="kw">xyz_disp</span>)
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(<span class="kw">disp_3d</span>)
</pre></div>
<p><img src="2_Visualizing_surface_displacements_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
</div>
<div id="visualizing-surface-displacements" class="section level3">
<h3 class="hasAnchor">
<a href="#visualizing-surface-displacements" class="anchor"></a>Visualizing surface displacements</h3>
<p>For visualization of the displacements in R, we can use <code>ggplot2</code> combined with the <code>metR</code> and <code>ggnewscale</code> packages. <code>metR</code> can create arrows indicating the magnitude and direction of displacement vectors, and <code>ggnewscale</code> lets us plot multiple <code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster()</a></code>â€™s each with their own fill scale and legend.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/eliocamp/metR">metR</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">ggnewscale</span>)

<span class="co"># Load hillshade for our map of displacements</span>
<span class="kw">hs2017</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span>(<span class="st">"rock_glacier_hillshade_2017_50cm.tif"</span>)
<span class="kw">hs2017_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>(<span class="kw">hs2017</span>, xy=<span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="kw">hs2017_df</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"hs"</span>)

<span class="co"># Estimate mean annual surface velocity (m/yr) over the five year period</span>
<span class="kw">d_tx</span><span class="op">$</span><span class="kw">mean_disp</span> <span class="op">&lt;-</span> <span class="kw">d_tx</span><span class="op">$</span><span class="kw">xyz_disp</span><span class="op">/</span><span class="fl">5</span>

<span class="co"># Make displacement map</span>
<span class="kw">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">d_tx</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x_source</span>,<span class="kw">y_source</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span>(data=<span class="kw">hs2017_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">x</span>, y=<span class="kw">y</span>, fill = <span class="kw">hs</span>), show.legend = <span class="fl">FALSE</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span>(high = <span class="st">"white"</span>, low = <span class="st">"black"</span>, na.value = <span class="st">"#FFFFFF"</span>) <span class="op">+</span> 
  <span class="co"># Allow for multiple scale fills using ggnewscale package</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggnewscale/man/new_scale.html">new_scale</a></span>(<span class="st">"fill"</span>) <span class="op">+</span>
  
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span>(data=<span class="kw">d_tx</span>, alpha = <span class="fl">0.4</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">x_source</span>, y=<span class="kw">y_source</span>, fill = <span class="kw">mean_disp</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>(name = <span class="st">"Mean annual\nsurface velocity\n(m/yr)"</span>, direction = <span class="fl">1</span>) <span class="op">+</span>
  
  <span class="co"># Create arrows using metR package</span>
  <span class="fu"><a href="https://rdrr.io/pkg/metR/man/geom_arrow.html">geom_arrow</a></span>(data=<span class="kw">d_tx</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(dx = <span class="kw">x_disp</span>, dy = <span class="kw">y_disp</span>), skip = <span class="fl">30</span>, show.legend = <span class="fl">FALSE</span>) <span class="op">+</span>
  
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Easting (m)"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Northing (m)"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">9</span>), axis.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">9</span>),
        axis.text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">6</span>), axis.text.y = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(angle = <span class="fl">90</span>))

<span class="kw">map</span>
</pre></div>
<p><img src="2_Visualizing_surface_displacements_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
</div>
<div id="references" class="section level3">
<h3 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h3>
<p>Arganda-Carreras, I., Sorzano, C. O., Marabini, R., Carazo, J. M., Ortiz-de-Solorzano, C., &amp; Kybic, J. (2006, May). Consistent and elastic registration of histological sections using vector-spline regularization. In International Workshop on Computer Vision Approaches to Medical Image Analysis (pp.Â 85-95). Springer, Berlin, Heidelberg.</p>
<p>Goetz, J., Fieguth, P., Kasiri, K., Bodin, X., Marcer, M., &amp; Brenning, A. (2019). Accounting for permafrost creep in high-resolution snow depth mapping by modelling sub-snow ground deformation. Remote Sensing of Environment, 231, 111275.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jason Goetz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
